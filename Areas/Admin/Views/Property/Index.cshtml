@model IEnumerable<HomeLengo.Models.Property>
@{
    ViewData["Title"] = "Quản lý Bất động sản";
}

<div class="main-content">
    <div class="main-content-inner">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="fw-7">Quản lý Bất động sản</h4>
            <a href="/Admin/Property/Create" class="tf-btn primary">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="white" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Thêm Bất động sản mới
            </a>
        </div>

        <div class="widget-box-2 wd-listing">
            <form method="get" action="/Admin/Property" class="wd-filter mb-3">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="ip-group icon-left">
                            <input type="text" name="searchString" value="@ViewBag.SearchString" placeholder="Tìm kiếm bất động sản...">
                            <span class="icon icon-search"></span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="ip-group">
                            <select name="statusId" class="form-select">
                                <option value="">Tất cả Trạng thái</option>
                                @foreach (var status in ViewBag.Statuses as SelectList)
                                {
                                    <option value="@status.Value" selected="@(status.Selected)">@status.Text</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="ip-group">
                            <select name="propertyTypeId" class="form-select">
                                <option value="">Tất cả Loại</option>
                                @foreach (var type in ViewBag.PropertyTypes as SelectList)
                                {
                                    <option value="@type.Value" selected="@(type.Selected)">@type.Text</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="tf-btn primary w-100">Tìm kiếm</button>
                    </div>
                </div>
            </form>

            <div class="d-flex gap-4 mb-3">
                <span class="text-primary fw-7">@ViewBag.TotalCount</span>
                <span class="fw-6">bất động sản được tìm thấy</span>
            </div>

            <div class="wrap-table">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Hình ảnh</th>
                                <th>Tiêu đề</th>
                                <th>Loại</th>
                                <th>Trạng thái</th>
                                <th>Giá</th>
                                <th>Vị trí</th>
                                <th>Ngày tạo</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                @foreach (var property in Model)
                                {
                                    // Lấy ảnh: ưu tiên primary, nếu không có thì lấy ảnh đầu tiên
                                    var photo = property.PropertyPhotos?
                                        .OrderByDescending(p => p.IsPrimary == true)
                                        .ThenBy(p => p.SortOrder ?? 0)
                                        .ThenBy(p => p.PhotoId)
                                        .FirstOrDefault();
                                    
                                    string GetImagePath(string filePath)
                                    {
                                        if (string.IsNullOrEmpty(filePath))
                                            return "~/assets/images/home/house-18.jpg";
                                        
                                        filePath = filePath.Trim();
                                        
                                        if (filePath.StartsWith("~/"))
                                            return filePath;
                                        
                                        if (filePath.StartsWith("/"))
                                            return "~" + filePath;
                                        
                                        if (filePath.Contains("assets/"))
                                            return "~/" + filePath.TrimStart('/');
                                        
                                        return "~/assets/images/home/" + filePath.TrimStart('/');
                                    }
                                    
                                    var photoPath = photo?.FilePath;
                                    var defaultPhoto = "~/assets/images/home/house-18.jpg";
                                    var photoUrl = !string.IsNullOrEmpty(photoPath) 
                                        ? Url.Content(GetImagePath(photoPath))
                                        : Url.Content(defaultPhoto);
                                    
                                    // Tạo class status với màu sắc khác nhau
                                    var statusName = property.Status?.Name?.ToLower() ?? "";
                                    var statusClass = statusName.Contains("rao bán") || statusName.Contains("for sale") ? "status-for-sale" :
                                                     statusName.Contains("đã bán") || statusName.Contains("sold") ? "status-sold" :
                                                     statusName.Contains("cho thuê") || statusName.Contains("for rent") ? "status-for-rent" :
                                                     statusName.Contains("pending") || statusName.Contains("chờ") ? "status-pending" :
                                                     statusName.Contains("draft") || statusName.Contains("nháp") ? "status-draft" :
                                                     "status-default";
                                    <tr>
                                        <td>
                                            <img src="@photoUrl" alt="@property.Title" style="width: 80px; height: 60px; object-fit: cover; border-radius: 4px;" onerror="this.onerror=null; this.src='@Url.Content(defaultPhoto)'">
                                        </td>
                                        <td>
                                            <div class="fw-6">@property.Title</div>
                                            <small class="text-muted">ID: @property.PropertyId</small>
                                        </td>
                                        <td>@(property.PropertyType?.Name ?? "Không có")</td>
                                        <td>
                                            <span class="btn-status @statusClass">@(property.Status?.Name ?? "Không xác định")</span>
                                        </td>
                                        <td>
                                            <span class="text-primary fw-6">@(property.Currency ?? "VND") @property.Price.ToString("N0")</span>
                                        </td>
                                        <td>
                                            <small>@(property.City?.Name ?? "Không có")</small>
                                            @if (property.District != null)
                                            {
                                                <br><small class="text-muted">@property.District.Name</small>
                                            }
                                        </td>
                                        <td>
                                            <small>@(property.CreatedAt?.ToString("dd MMM yyyy") ?? "Không có")</small>
                                        </td>
                                        <td>
                                            <ul class="list-action d-flex gap-2">
                                                <li>
                                                    <a href="/Admin/Property/Details/@property.PropertyId" class="item" title="Xem">
                                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M8 3C4.667 3 2 5.667 2 9C2 12.333 4.667 15 8 15C11.333 15 14 12.333 14 9C14 5.667 11.333 3 8 3ZM8 13.5C5.5 13.5 3.5 11.5 3.5 9C3.5 6.5 5.5 4.5 8 4.5C10.5 4.5 12.5 6.5 12.5 9C12.5 11.5 10.5 13.5 8 13.5Z" fill="#A3ABB0"/>
                                                            <path d="M8 6.5C6.9 6.5 6 7.4 6 8.5C6 9.6 6.9 10.5 8 10.5C9.1 10.5 10 9.6 10 8.5C10 7.4 9.1 6.5 8 6.5Z" fill="#A3ABB0"/>
                                                        </svg>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="/Admin/Property/Edit/@property.PropertyId" class="item" title="Sửa">
                                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M11.2413 2.9915L12.366 1.86616C12.6005 1.63171 12.9184 1.5 13.25 1.5C13.5816 1.5 13.8995 1.63171 14.134 1.86616C14.3685 2.10062 14.5002 2.4186 14.5002 2.75016C14.5002 3.08173 14.3685 3.39971 14.134 3.63416L4.55467 13.2135C4.20222 13.5657 3.76758 13.8246 3.29 13.9668L1.5 14.5002L2.03333 12.7102C2.17552 12.2326 2.43442 11.7979 2.78667 11.4455L11.242 2.9915H11.2413ZM11.2413 2.9915L13 4.75016" stroke="#A3ABB0" stroke-linecap="round" stroke-linejoin="round" />
                                                        </svg>
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="/Admin/Property/Delete/@property.PropertyId" class="remove-file item" title="Xóa" onclick="return confirm('Bạn có chắc chắn muốn xóa bất động sản này?');">
                                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M9.82667 6.00035L9.596 12.0003M6.404 12.0003L6.17333 6.00035M12.8187 3.86035C13.0467 3.89501 13.2733 3.93168 13.5 3.97101M12.8187 3.86035L12.1067 13.1157C12.0776 13.4925 11.9074 13.8445 11.63 14.1012C11.3527 14.3579 10.9886 14.5005 10.6107 14.5003H5.38933C5.0114 14.5005 4.64735 14.3579 4.36999 14.1012C4.09262 13.8445 3.92239 13.4925 3.89333 13.1157L3.18133 3.86035M12.8187 3.86035C12.0492 3.74403 11.2758 3.65574 10.5 3.59568M3.18133 3.86035C2.95333 3.89435 2.72667 3.93101 2.5 3.97035M3.18133 3.86035C3.95076 3.74403 4.72416 3.65575 5.5 3.59568M10.5 3.59568V2.98501C10.5 2.19835 9.89333 1.54235 9.10667 1.51768C8.36908 1.49411 7.63092 1.49411 6.89333 1.51768C6.10667 1.54235 5.5 2.19901 5.5 2.98501V3.59568M10.5 3.59568C8.83581 3.46707 7.16419 3.46707 5.5 3.59568" stroke="#A3ABB0" stroke-linecap="round" stroke-linejoin="round" />
                                                        </svg>
                                                    </a>
                                                </li>
                                            </ul>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="8" class="text-center py-4">Không tìm thấy bất động sản nào</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @if (ViewBag.TotalPages > 1)
                {
                    <ul class="wd-navigation">
                        @if (ViewBag.CurrentPage > 1)
                        {
                            <li><a href="?page=@(ViewBag.CurrentPage - 1)&searchString=@ViewBag.SearchString&statusId=@ViewBag.StatusId&propertyTypeId=@ViewBag.PropertyTypeId" class="nav-item"><i class="icon icon-arr-l"></i></a></li>
                        }
                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            if (i == ViewBag.CurrentPage)
                            {
                                <li><a href="#" class="nav-item active">@i</a></li>
                            }
                            else if (i <= 3 || i > ViewBag.TotalPages - 3 || (i >= ViewBag.CurrentPage - 1 && i <= ViewBag.CurrentPage + 1))
                            {
                                <li><a href="?page=@i&searchString=@ViewBag.SearchString&statusId=@ViewBag.StatusId&propertyTypeId=@ViewBag.PropertyTypeId" class="nav-item">@i</a></li>
                            }
                            else if (i == 4 || i == ViewBag.TotalPages - 3)
                            {
                                <li><a href="#" class="nav-item">...</a></li>
                            }
                        }
                        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                        {
                            <li><a href="?page=@(ViewBag.CurrentPage + 1)&searchString=@ViewBag.SearchString&statusId=@ViewBag.StatusId&propertyTypeId=@ViewBag.PropertyTypeId" class="nav-item"><i class="icon icon-arr-r"></i></a></li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>
</div>












