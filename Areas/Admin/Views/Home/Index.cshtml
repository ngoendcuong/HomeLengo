@using HomeLengo.Models
@{
    dynamic stats = ViewBag.Stats;
    var recentProperties = new List<Property>();
    var recentMessages = new List<Message>();
    var recentReviews = new List<Review>();
    
    if (stats != null)
    {
        try
        {
            recentProperties = stats.RecentProperties as List<Property> ?? new List<Property>();
            recentMessages = stats.RecentMessages as List<Message> ?? new List<Message>();
            recentReviews = stats.RecentReviews as List<Review> ?? new List<Review>();
        }
        catch
        {
            // Nếu có lỗi, sử dụng danh sách rỗng
            recentProperties = new List<Property>();
            recentMessages = new List<Message>();
            recentReviews = new List<Review>();
        }
    }
}

<div class="main-content">
    <div class="main-content-inner">
        <div class="button-show-hide show-mb">
            <span class="body-1">Show Dashboard</span>
        </div>
        <div class="flat-counter-v2 tf-counter">
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-listing"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Total Properties</div>
                    <div class="box-count d-flex align-items-end">
                        <h3 class="fw-8">@(stats?.TotalProperties ?? 0)</h3>
                    </div>
                </div>
            </div>
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-pending"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Pending Properties</div>
                    <div class="box-count d-flex align-items-end">
                        <h3 class="fw-8">@(stats?.PendingProperties ?? 0)</h3>
                    </div>
                </div>
            </div>
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-favorite"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Total Users</div>
                    <div class="d-flex align-items-end">
                        <h3 class="fw-8">@(stats?.TotalUsers ?? 0)</h3>
                    </div>
                </div>
            </div>
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-review"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Total Reviews</div>
                    <div class="d-flex align-items-end">
                        <h3 class="fw-8">@(stats?.TotalReviews ?? 0)</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="wrapper-content row">
            <div class="col-xl-9">
                <div class="widget-box-2 wd-listing">
                    <h5 class="title">Recent Properties</h5>
                    <div class="d-flex gap-4">
                        <span class="text-primary fw-7">@recentProperties.Count</span>
                        <span class="fw-6">Properties found</span>
                    </div>
                    <div class="wrap-table">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Listing</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (recentProperties.Any())
                                    {
                                        @foreach (var property in recentProperties)
                                        {
                                            // Lấy ảnh: ưu tiên primary, nếu không có thì lấy ảnh đầu tiên
                                            var photo = property.PropertyPhotos?
                                                .OrderByDescending(p => p.IsPrimary == true)
                                                .ThenBy(p => p.SortOrder ?? 0)
                                                .ThenBy(p => p.PhotoId)
                                                .FirstOrDefault();
                                            
                                            string GetImagePath(string filePath)
                                            {
                                                if (string.IsNullOrEmpty(filePath))
                                                    return "~/assets/images/home/house-18.jpg";
                                                
                                                filePath = filePath.Trim();
                                                
                                                if (filePath.StartsWith("~/"))
                                                    return filePath;
                                                
                                                if (filePath.StartsWith("/"))
                                                    return "~" + filePath;
                                                
                                                if (filePath.Contains("assets/"))
                                                    return "~/" + filePath.TrimStart('/');
                                                
                                                return "~/assets/images/home/" + filePath.TrimStart('/');
                                            }
                                            
                                            var photoPath = photo?.FilePath;
                                            var defaultPhoto = "~/assets/images/home/house-18.jpg";
                                            var photoUrl = !string.IsNullOrEmpty(photoPath) 
                                                ? Url.Content(GetImagePath(photoPath))
                                                : Url.Content(defaultPhoto);
                                            
                                            // Tạo class status với màu sắc khác nhau
                                            var statusName = property.Status?.Name?.ToLower() ?? "";
                                            var statusClass = statusName.Contains("rao bán") || statusName.Contains("for sale") ? "status-for-sale" :
                                                             statusName.Contains("đã bán") || statusName.Contains("sold") ? "status-sold" :
                                                             statusName.Contains("cho thuê") || statusName.Contains("for rent") ? "status-for-rent" :
                                                             statusName.Contains("pending") || statusName.Contains("chờ") ? "status-pending" :
                                                             statusName.Contains("draft") || statusName.Contains("nháp") ? "status-draft" :
                                                             "status-default";
                                            <tr class="file-delete">
                                                <td>
                                                    <div class="listing-box">
                                                        <div class="images">
                                                            <img src="@photoUrl" alt="@property.Title" onerror="this.onerror=null; this.src='@Url.Content(defaultPhoto)'">
                                                        </div>
                                                        <div class="content">
                                                            <div class="title">
                                                                <a href="/Property/Details/@property.PropertyId" class="link">@property.Title</a>
                                                            </div>
                                                            <div class="text-date">Posting date: @(property.CreatedAt?.ToString("MMMM dd, yyyy") ?? "N/A")</div>
                                                            <div class="text-btn text-primary">@(property.Currency ?? "VND") @property.Price.ToString("N0")</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="status-wrap">
                                                        <a href="#" class="btn-status @statusClass">@(property.Status?.Name ?? "Unknown")</a>
                                                    </div>
                                                </td>
                                                <td>
                                                    <ul class="list-action">
                                                        <li>
                                                            <a href="/Admin/Property/Edit/@property.PropertyId" class="item">
                                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <path d="M11.2413 2.9915L12.366 1.86616C12.6005 1.63171 12.9184 1.5 13.25 1.5C13.5816 1.5 13.8995 1.63171 14.134 1.86616C14.3685 2.10062 14.5002 2.4186 14.5002 2.75016C14.5002 3.08173 14.3685 3.39971 14.134 3.63416L4.55467 13.2135C4.20222 13.5657 3.76758 13.8246 3.29 13.9668L1.5 14.5002L2.03333 12.7102C2.17552 12.2326 2.43442 11.7979 2.78667 11.4455L11.242 2.9915H11.2413ZM11.2413 2.9915L13 4.75016" stroke="#A3ABB0" stroke-linecap="round" stroke-linejoin="round" />
                                                                </svg>
                                                                Edit
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a href="/Admin/Property/Delete/@property.PropertyId" class="remove-file item" onclick="return confirm('Are you sure you want to delete this property?');">
                                                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <path d="M9.82667 6.00035L9.596 12.0003M6.404 12.0003L6.17333 6.00035M12.8187 3.86035C13.0467 3.89501 13.2733 3.93168 13.5 3.97101M12.8187 3.86035L12.1067 13.1157C12.0776 13.4925 11.9074 13.8445 11.63 14.1012C11.3527 14.3579 10.9886 14.5005 10.6107 14.5003H5.38933C5.0114 14.5005 4.64735 14.3579 4.36999 14.1012C4.09262 13.8445 3.92239 13.4925 3.89333 13.1157L3.18133 3.86035M12.8187 3.86035C12.0492 3.74403 11.2758 3.65574 10.5 3.59568M3.18133 3.86035C2.95333 3.89435 2.72667 3.93101 2.5 3.97035M3.18133 3.86035C3.95076 3.74403 4.72416 3.65575 5.5 3.59568M10.5 3.59568V2.98501C10.5 2.19835 9.89333 1.54235 9.10667 1.51768C8.36908 1.49411 7.63092 1.49411 6.89333 1.51768C6.10667 1.54235 5.5 2.19901 5.5 2.98501V3.59568M10.5 3.59568C8.83581 3.46707 7.16419 3.46707 5.5 3.59568" stroke="#A3ABB0" stroke-linecap="round" stroke-linejoin="round" />
                                                                </svg>
                                                                Delete
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center">No properties found</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3">
                <div class="widget-box-2 mess-box mb-20">
                    <h5 class="title">Recent Messages</h5>
                    <ul class="list-mess">
                        @if (recentMessages.Any())
                        {
                            @foreach (var message in recentMessages)
                            {
                                var avatarFileName = !string.IsNullOrEmpty(message.FromUser?.Avatar) ? message.FromUser.Avatar : "avatarMacDinh.jpg";
                                var avatarPath = $"~/assets/images/avatar/{avatarFileName}";
                                var timeAgo = message.SentAt.HasValue ? 
                                    (DateTime.UtcNow - message.SentAt.Value).Days > 0 ? 
                                        $"{(DateTime.UtcNow - message.SentAt.Value).Days} day ago" : 
                                        "Today" : "N/A";
                                <li class="mess-item">
                                    <div class="user-box">
                                        <div class="avatar">
                                            <img src="@Url.Content(avatarPath)" alt="@(message.FromUser?.FullName ?? "User")" onerror="this.onerror=null; this.src='@Url.Content("~/assets/images/avatar/avatarMacDinh.jpg")'">
                                        </div>
                                        <div class="content">
                                            <div class="name fw-6">@(message.FromUser?.FullName ?? message.FromUser?.Username ?? "Unknown")</div>
                                            <span class="caption-2 text-variant-3">@timeAgo</span>
                                        </div>
                                    </div>
                                    <p>@(message.Subject ?? "No subject")</p>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="mess-item">
                                <p>No messages found</p>
                            </li>
                        }
                    </ul>
                </div>
                <div class="widget-box-2 mess-box">
                    <h5 class="title">Recent Reviews</h5>
                    <ul class="list-mess">
                        @if (recentReviews.Any())
                        {
                            @foreach (var review in recentReviews)
                            {
                                var avatarFileName = !string.IsNullOrEmpty(review.User?.Avatar) ? review.User.Avatar : "avatarMacDinh.jpg";
                                var avatarPath = $"~/assets/images/avatar/{avatarFileName}";
                                var timeAgo = review.CreatedAt.HasValue ? 
                                    (DateTime.UtcNow - review.CreatedAt.Value).Days > 0 ? 
                                        $"{(DateTime.UtcNow - review.CreatedAt.Value).Days} day ago" : 
                                        "Today" : "N/A";
                                <li class="mess-item">
                                    <div class="user-box">
                                        <div class="avatar">
                                            <img src="@Url.Content(avatarPath)" alt="@(review.User?.FullName ?? "User")" onerror="this.onerror=null; this.src='@Url.Content("~/assets/images/avatar/avatarMacDinh.jpg")'">
                                        </div>
                                        <div class="content">
                                            <div class="name fw-6">@(review.User?.FullName ?? review.User?.Username ?? "Unknown")</div>
                                            <span class="caption-2 text-variant-3">@timeAgo</span>
                                        </div>
                                    </div>
                                    <p>@(review.Title ?? "No title")</p>
                                    <ul class="list-star">
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            <li class="icon @(i < review.Rating ? "icon-star" : "icon-star-empty")"></li>
                                        }
                                    </ul>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="mess-item">
                                <p>No reviews found</p>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="footer-dashboard">
        <p>Copyright © 2024 Home Lengo</p>
    </div>
</div>
