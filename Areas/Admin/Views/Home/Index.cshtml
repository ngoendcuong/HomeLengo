@using HomeLengo.Models
@{
    dynamic stats = ViewBag.Stats;

    var recentProperties = new List<Property>();
    var recentMessages = new List<Message>();
    var recentReviews = new List<Review>();
    var activePackage = ViewBag.ActivePackage as UserServicePackage;

    // ====== STATS SAFE ======
    int totalActiveListings = 0;     //tin đang hoạt động (StatusId 1/2)
    int forSaleCount = 0;            // StatusId 1
    int forRentCount = 0;            // StatusId 2
    int totalReviews = 0;
    int totalPostedListings = 0;
    if (stats != null)
    {
        try { totalPostedListings = stats.TotalProperties ?? 0; } catch { totalPostedListings = 0; }
    }


    int? remainingListings = null;   // null = không giới hạn

    if (stats != null)
    {
        try { totalActiveListings = stats.TotalProperties ?? 0; } catch { totalActiveListings = 0; }
        try { forSaleCount = stats.ForSaleCount ?? 0; } catch { forSaleCount = 0; }
        try { forRentCount = stats.ForRentCount ?? 0; } catch { forRentCount = 0; }
        try { totalReviews = stats.TotalReviews ?? 0; } catch { totalReviews = 0; }

        try { remainingListings = stats.RemainingListings; } catch { remainingListings = null; }

        try
        {
            recentProperties = stats.RecentProperties as List<Property> ?? new List<Property>();
            recentMessages = stats.RecentMessages as List<Message> ?? new List<Message>();
            recentReviews = stats.RecentReviews as List<Review> ?? new List<Review>();
        }
        catch
        {
            recentProperties = new List<Property>();
            recentMessages = new List<Message>();
            recentReviews = new List<Review>();
        }
    }

    var hasPackage = ViewBag.HasPackage as bool? ?? false;
}

<div class="main-content">
    <div class="main-content-inner">
        <div class="button-show-hide show-mb">
            <span class="body-1">Hiển thị Bảng điều khiển</span>
        </div>

        @* ====== WIDGET GÓI DỊCH VỤ ====== *@
        @if (activePackage != null)
        {
            <div class="widget-box-2 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="title mb-2">Gói dịch vụ đang sử dụng</h5>

                        <div class="d-flex align-items-center gap-3 flex-wrap">
                            <span class="badge bg-primary fs-6">@activePackage.Plan.Name</span>
                            <span class="text-muted">Giá: @activePackage.Plan.Price.ToString("N0")đ/tháng</span>
                            <span class="text-muted">Bắt đầu: @activePackage.StartDate.ToString("dd/MM/yyyy")</span>
                        </div>

                        @* ✅ HIỂN THỊ GIỚI HẠN + ĐÃ DÙNG + CÒN LẠI *@
                        @if (activePackage.Plan.MaxListings.HasValue && activePackage.Plan.MaxListings.Value > 0)
                        {
                            <div class="mt-2">
                                <small class="text-muted">
                                    Giới hạn đăng tin: <b>@activePackage.Plan.MaxListings.Value</b> tin
                                    | Đã dùng: <b>@totalActiveListings</b>
                                    | Còn lại: <b>@(remainingListings ?? 0)</b>
                                </small>
                            </div>
                        }
                        else
                        {
                            <div class="mt-2">
                                <small class="text-success">
                                    Không giới hạn số lượng đăng tin
                                    | Đang hoạt động: <b>@totalActiveListings</b>
                                </small>
                            </div>
                        }
                    </div>

                    <a href="/pages/Pricing" class="btn btn-outline-primary">Nâng cấp gói</a>
                </div>
            </div>
        }
        else
        {
            <div class="widget-box-2 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="title mb-2">Bạn chưa có gói dịch vụ</h5>
                        <p class="text-muted mb-0">Mua gói dịch vụ để sử dụng các chức năng đăng tin và xem thống kê chi tiết.</p>
                    </div>
                    <a href="/pages/Pricing" class="btn btn-primary">Mua gói ngay</a>
                </div>
            </div>
        }

        @* ====== 4 Ô THỐNG KÊ ====== *@
        <div class="flat-counter-v2 tf-counter">
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-listing"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Đã đăng</div>
                    <div class="box-count d-flex align-items-end">
                        <h3 class="fw-8">@totalPostedListings</h3>
                    </div>
                </div>
            </div>

            @* ✅ ĐỔI: Pending -> Rao bán *@
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-pending"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Rao bán</div>
                    <div class="box-count d-flex align-items-end">
                        <h3 class="fw-8">@forSaleCount</h3>
                    </div>
                </div>
            </div>

            @* ✅ ĐỔI: TotalUsers -> Cho thuê *@
            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-favorite"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Cho thuê</div>
                    <div class="d-flex align-items-end">
                        <h3 class="fw-8">@forRentCount</h3>
                    </div>
                </div>
            </div>

            <div class="counter-box">
                <div class="box-icon">
                    <span class="icon icon-review"></span>
                </div>
                <div class="content-box">
                    <div class="title-count text-variant-1">Tổng số Đánh giá</div>
                    <div class="d-flex align-items-end">
                        <h3 class="fw-8">@totalReviews</h3>
                    </div>
                </div>
            </div>
        </div>

        @* ====== PHẦN CÒN LẠI CỦA VIEW GIỮ NGUYÊN NHƯ BẠN (BĐS gần đây / Tin nhắn / Đánh giá ...) ====== *@

        <div class="wrapper-content row">
            <div class="col-xl-9">
                <div class="widget-box-2 wd-listing">
                    <h5 class="title">Bất động sản gần đây</h5>
                    <div class="d-flex gap-4">
                        <span class="text-primary fw-7">@recentProperties.Count</span>
                        <span class="fw-6">bất động sản được tìm thấy</span>
                    </div>

                    <div class="wrap-table">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Danh sách</th>
                                        <th>Trạng thái</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (recentProperties.Any())
                                    {
                                        @foreach (var property in recentProperties)
                                        {
                                            var photo = property.PropertyPhotos?
                                            .OrderByDescending(p => p.IsPrimary == true)
                                            .ThenBy(p => p.SortOrder ?? 0)
                                            .ThenBy(p => p.PhotoId)
                                            .FirstOrDefault();

                                            string GetImagePath(string filePath)
                                            {
                                                if (string.IsNullOrEmpty(filePath))
                                                    return "~/assets/images/home/house-18.jpg";

                                                filePath = filePath.Trim();

                                                if (filePath.StartsWith("~/"))
                                                    return filePath;

                                                if (filePath.StartsWith("/"))
                                                    return "~" + filePath;

                                                if (filePath.Contains("assets/"))
                                                    return "~/" + filePath.TrimStart('/');

                                                return "~/assets/images/home/" + filePath.TrimStart('/');
                                            }

                                            var photoPath = photo?.FilePath;
                                            var defaultPhoto = "~/assets/images/home/house-18.jpg";
                                            var photoUrl = !string.IsNullOrEmpty(photoPath)
                                            ? Url.Content(GetImagePath(photoPath))
                                            : Url.Content(defaultPhoto);

                                            var statusName = property.Status?.Name?.ToLower() ?? "";
                                            var statusClass = statusName.Contains("rao bán") || statusName.Contains("for sale") ? "status-for-sale" :
                                            statusName.Contains("đã bán") || statusName.Contains("sold") ? "status-sold" :
                                            statusName.Contains("cho thuê") || statusName.Contains("for rent") ? "status-for-rent" :
                                            statusName.Contains("pending") || statusName.Contains("chờ") ? "status-pending" :
                                            statusName.Contains("draft") || statusName.Contains("nháp") ? "status-draft" :
                                            "status-default";
                                            <tr class="file-delete">
                                                <td>
                                                    <div class="listing-box">
                                                        <div class="images">
                                                            <img src="@photoUrl" alt="@property.Title" onerror="this.onerror=null; this.src='@Url.Content(defaultPhoto)'">
                                                        </div>
                                                        <div class="content">
                                                            <div class="title">
                                                                <a href="/Property/Details/@property.PropertyId" class="link">@property.Title</a>
                                                            </div>
                                                            <div class="text-date">Ngày đăng: @(property.CreatedAt?.ToString("dd MMMM yyyy") ?? "Không có")</div>
                                                            <div class="text-btn text-primary">@(property.Currency ?? "VND") @property.Price.ToString("N0")</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="status-wrap">
                                                        <a href="#" class="btn-status @statusClass">@(property.Status?.Name ?? "Không xác định")</a>
                                                    </div>
                                                </td>
                                                <td>
                                                    <ul class="list-action">
                                                        <li>
                                                            <a href="/Admin/Property/Edit/@property.PropertyId" class="item">
                                                                Sửa
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a href="/Admin/Property/Delete/@property.PropertyId" class="remove-file item" onclick="return confirm('Bạn có chắc chắn muốn xóa bất động sản này?');">
                                                                Xóa
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="3" class="text-center">Không tìm thấy bất động sản nào</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-xl-3">
                <div class="widget-box-2 mess-box mb-20">
                    <h5 class="title">Tin nhắn gần đây</h5>
                    <ul class="list-mess">
                        @if (recentMessages.Any())
                        {
                            @foreach (var message in recentMessages)
                            {
                                var avatarFileName = !string.IsNullOrEmpty(message.FromUser?.Avatar) ? message.FromUser.Avatar : "avatarMacDinh.jpg";
                                var avatarPath = $"~/assets/images/avatar/{avatarFileName}";
                                var timeAgo = message.SentAt.HasValue ?
                                (DateTime.UtcNow - message.SentAt.Value).Days > 0 ?
                                $"{(DateTime.UtcNow - message.SentAt.Value).Days} ngày trước" :
                                "Hôm nay" : "Không có";
                                <li class="mess-item">
                                    <div class="user-box">
                                        <div class="avatar">
                                            <img src="@Url.Content(avatarPath)" alt="@(message.FromUser?.FullName ?? "Người dùng")"
                                                 onerror="this.onerror=null; this.src='@Url.Content("~/assets/images/avatar/avatarMacDinh.jpg")'">
                                        </div>
                                        <div class="content">
                                            <div class="name fw-6">@(message.FromUser?.FullName ?? message.FromUser?.Username ?? "Không xác định")</div>
                                            <span class="caption-2 text-variant-3">@timeAgo</span>
                                        </div>
                                    </div>
                                    <p>@(message.Subject ?? "Không có chủ đề")</p>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="mess-item"><p>Không tìm thấy tin nhắn nào</p></li>
                        }
                    </ul>
                </div>

                <div class="widget-box-2 mess-box">
                    <h5 class="title">Đánh giá gần đây</h5>
                    <ul class="list-mess">
                        @if (recentReviews.Any())
                        {
                            @foreach (var review in recentReviews)
                            {
                                var avatarFileName = !string.IsNullOrEmpty(review.User?.Avatar) ? review.User.Avatar : "avatarMacDinh.jpg";
                                var avatarPath = $"~/assets/images/avatar/{avatarFileName}";
                                var timeAgo = review.CreatedAt.HasValue ?
                                (DateTime.UtcNow - review.CreatedAt.Value).Days > 0 ?
                                $"{(DateTime.UtcNow - review.CreatedAt.Value).Days} ngày trước" :
                                "Hôm nay" : "Không có";
                                <li class="mess-item">
                                    <div class="user-box">
                                        <div class="avatar">
                                            <img src="@Url.Content(avatarPath)" alt="@(review.User?.FullName ?? "Người dùng")"
                                                 onerror="this.onerror=null; this.src='@Url.Content("~/assets/images/avatar/avatarMacDinh.jpg")'">
                                        </div>
                                        <div class="content">
                                            <div class="name fw-6">@(review.User?.FullName ?? review.User?.Username ?? "Không xác định")</div>
                                            <span class="caption-2 text-variant-3">@timeAgo</span>
                                        </div>
                                    </div>
                                    <p>@(review.Title ?? "Không có tiêu đề")</p>
                                    <ul class="list-star">
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            <li class="icon @(i < review.Rating ? "icon-star" : "icon-star-empty")"></li>
                                        }
                                    </ul>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="mess-item"><p>Không tìm thấy đánh giá nào</p></li>
                        }
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <div class="footer-dashboard">
        <p>Copyright © 2024 Home Lengo</p>
    </div>
</div>
