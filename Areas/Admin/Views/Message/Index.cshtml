@model IEnumerable<HomeLengo.Models.Message>
@{
    ViewData["Title"] = "Tin nhắn";
    
    // Helper function to calculate time ago
    string GetTimeAgo(DateTime? dateTime)
    {
        if (!dateTime.HasValue) return "Không có";
        
        var timeSpan = DateTime.UtcNow - dateTime.Value;
        
        if (timeSpan.TotalDays >= 365)
        {
            var years = (int)(timeSpan.TotalDays / 365);
            return years == 1 ? "1 năm trước" : $"{years} năm trước";
        }
        else if (timeSpan.TotalDays >= 30)
        {
            var months = (int)(timeSpan.TotalDays / 30);
            return months == 1 ? "1 tháng trước" : $"{months} tháng trước";
        }
        else if (timeSpan.TotalDays >= 1)
        {
            var days = (int)timeSpan.TotalDays;
            return days == 1 ? "1 ngày trước" : $"{days} ngày trước";
        }
        else if (timeSpan.TotalHours >= 1)
        {
            var hours = (int)timeSpan.TotalHours;
            return hours == 1 ? "1 giờ trước" : $"{hours} giờ trước";
        }
        else if (timeSpan.TotalMinutes >= 1)
        {
            var minutes = (int)timeSpan.TotalMinutes;
            return minutes == 1 ? "1 phút trước" : $"{minutes} phút trước";
        }
        else
        {
            return "Vừa xong";
        }
    }
    
    // Helper function to get avatar path
    string GetAvatarPath(string? avatar)
    {
        var avatarFileName = !string.IsNullOrEmpty(avatar) ? avatar : "avatarMacDinh.jpg";
        return $"~/assets/images/avatar/{avatarFileName}";
    }
    
    // Helper function to truncate text
    string TruncateText(string? text, int maxLength = 100)
    {
        if (string.IsNullOrEmpty(text)) return "Không có nội dung tin nhắn";
        if (text.Length <= maxLength) return text;
        return text.Substring(0, maxLength) + "...";
    }
}

<div class="main-content">
    <div class="main-content-inner wrap-dashboard-content">
        <div class="button-show-hide show-mb">
            <span class="body-1">Hiển thị Bảng điều khiển</span>
        </div>
        
        @{
            var userIdStr = Context.Session.GetString("UserId");
            int currentUserId = 0;
            int.TryParse(userIdStr, out currentUserId);
        }
        
        <!-- Search and Filter Section -->
        <div class="row mb-4">
            <div class="col-md-8">
                <form method="get" action="/Admin/Message" class="wd-filter">
                    <div class="ip-group icon-left">
                        <input type="text" name="searchString" value="@ViewBag.SearchString" placeholder="Tìm kiếm tin nhắn...">
                        <span class="icon icon-search"></span>
                    </div>
                </form>
            </div>
            <div class="col-md-4">
                <form method="get" action="/Admin/Message" id="filterForm">
                    <input type="hidden" name="searchString" value="@ViewBag.SearchString">
                    <div class="nice-select" tabindex="0">
                        <span class="current">
                            @if (ViewBag.IsRead == true)
                            {
                                <text>Đã đọc</text>
                            }
                            else if (ViewBag.IsRead == false)
                            {
                                <text>Chưa đọc</text>
                            }
                            else
                            {
                                <text>Tất cả tin nhắn</text>
                            }
                        </span>
                        <ul class="list">
                            <li data-value="" class="option @(ViewBag.IsRead == null ? "selected" : "")">Tất cả tin nhắn</li>
                            <li data-value="false" class="option @(ViewBag.IsRead == false ? "selected" : "")">Chưa đọc</li>
                            <li data-value="true" class="option @(ViewBag.IsRead == true ? "selected" : "")">Đã đọc</li>
                        </ul>
                    </div>
                    <input type="hidden" name="isRead" id="isRead" value="@ViewBag.IsRead">
                </form>
            </div>
        </div>
        
        <!-- Message Count -->
        <div class="d-flex gap-4 mb-3">
            <span class="text-primary fw-7">@ViewBag.TotalCount</span>
            <span class="fw-6">tin nhắn được tìm thấy</span>
        </div>
        
        <!-- Messages List -->
        <div class="widget-box-2 mess-box">
            <h5 class="title">Tin nhắn</h5>
            @if (Model != null && Model.Any())
            {
                <ul class="list-mess">
                    @foreach (var message in Model)
                    {
                        // Determine the other user (not the current logged-in user)
                        var otherUser = message.FromUserId == currentUserId ? message.ToUser : message.FromUser;
                        var isUnread = message.IsRead == false && message.ToUserId == currentUserId;
                        var isSent = message.FromUserId == currentUserId;
                        
                        var otherUserName = otherUser?.FullName ?? otherUser?.Username ?? "Người dùng không xác định";
                        var otherUserAvatar = GetAvatarPath(otherUser?.Avatar);
                        var timeAgo = GetTimeAgo(message.SentAt);
                        var messagePreview = TruncateText(message.Body);
                        var messageSubject = !string.IsNullOrEmpty(message.Subject) ? message.Subject : "Không có chủ đề";
                        
                        <li class="mess-item @(isUnread ? "unread" : "")" data-message-id="@message.MessageId">
                            <div class="mess-item-header">
                                <div class="user-box">
                                    <div class="avatar">
                                        <img src="@Url.Content(otherUserAvatar)" alt="@otherUserName" onerror="this.onerror=null; this.src='@Url.Content("~/assets/images/avatar/avatarMacDinh.jpg")'">
                                    </div>
                                    <div class="content">
                                        <div class="name fw-6">
                                            @otherUserName
                                            @if (isUnread)
                                            {
                                                <span class="unread-badge"></span>
                                            }
                                        </div>
                                        <span class="caption-2 text-variant-3">@timeAgo</span>
                                    </div>
                                </div>
                                <div class="mess-actions">
                                    <div class="dropdown">
                                        <button class="btn-action" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M8 4C8.55228 4 9 3.55228 9 3C9 2.44772 8.55228 2 8 2C7.44772 2 7 2.44772 7 3C7 3.55228 7.44772 4 8 4Z" fill="#A3ABB0"/>
                                                <path d="M8 9C8.55228 9 9 8.55228 9 8C9 7.44772 8.55228 7 8 7C7.44772 7 7 7.44772 7 8C7 8.55228 7.44772 9 8 9Z" fill="#A3ABB0"/>
                                                <path d="M8 14C8.55228 14 9 13.5523 9 13C9 12.4477 8.55228 12 8 12C7.44772 12 7 12.4477 7 13C7 13.5523 7.44772 14 8 14Z" fill="#A3ABB0"/>
                                            </svg>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item" href="/Admin/Message/Details/@message.MessageId">
                                                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                                        <path d="M8 3C4.667 3 2 5.667 2 9C2 12.333 4.667 15 8 15C11.333 15 14 12.333 14 9C14 5.667 11.333 3 8 3ZM8 13.5C5.5 13.5 3.5 11.5 3.5 9C3.5 6.5 5.5 4.5 8 4.5C10.5 4.5 12.5 6.5 12.5 9C12.5 11.5 10.5 13.5 8 13.5Z" fill="#A3ABB0"/>
                                                        <path d="M8 6.5C6.9 6.5 6 7.4 6 8.5C6 9.6 6.9 10.5 8 10.5C9.1 10.5 10 9.6 10 8.5C10 7.4 9.1 6.5 8 6.5Z" fill="#A3ABB0"/>
                                                    </svg>
                                                    Xem chi tiết
                                                </a>
                                            </li>
                                            @if (isUnread)
                                            {
                                                <li>
                                                    <form method="post" action="/Admin/Message/MarkAsRead/@message.MessageId" style="display:inline;">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="dropdown-item" style="background:none; border:none; width:100%; text-align:left; padding:8px 16px;">
                                                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                                                <path d="M13.5 4L6 11.5L2.5 8" stroke="#A3ABB0" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                            </svg>
                                                            Đánh dấu đã đọc
                                                        </button>
                                                    </form>
                                                </li>
                                            }
                                            <li><hr class="dropdown-divider"></li>
                                            <li>
                                                <form method="post" action="/Admin/Message/Delete/@message.MessageId" style="display:inline;">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Bạn có chắc chắn muốn xóa tin nhắn này?');" style="background:none; border:none; width:100%; text-align:left; padding:8px 16px;">
                                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                                                            <path d="M9.82667 6.00035L9.596 12.0003M6.404 12.0003L6.17333 6.00035M12.8187 3.86035C13.0467 3.89501 13.2733 3.93168 13.5 3.97101M12.8187 3.86035L12.1067 13.1157C12.0776 13.4925 11.9074 13.8445 11.63 14.1012C11.3527 14.3579 10.9886 14.5005 10.6107 14.5003H5.38933C5.0114 14.5005 4.64735 14.3579 4.36999 14.1012C4.09262 13.8445 3.92239 13.4925 3.89333 13.1157L3.18133 3.86035M12.8187 3.86035C12.0492 3.74403 11.2758 3.65574 10.5 3.59568M3.18133 3.86035C2.95333 3.89435 2.72667 3.93101 2.5 3.97035M3.18133 3.86035C3.95076 3.74403 4.72416 3.65575 5.5 3.59568M10.5 3.59568V2.98501C10.5 2.19835 9.89333 1.54235 9.10667 1.51768C8.36908 1.49411 7.63092 1.49411 6.89333 1.51768C6.10667 1.54235 5.5 2.19901 5.5 2.98501V3.59568M10.5 3.59568C8.83581 3.46707 7.16419 3.46707 5.5 3.59568" stroke="#dc3545" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                        Xóa
                                                    </button>
                                                </form>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <a href="/Admin/Message/Details/@message.MessageId" class="mess-content-link">
                                <div class="mess-subject fw-6 mb-1">@messageSubject</div>
                                <p>@messagePreview</p>
                                @if (message.Property != null)
                                {
                                    <div class="mess-property mt-2">
                                        <span class="icon icon-home" style="margin-right: 4px;"></span>
                                        <span class="caption-2 text-variant-3">Bất động sản: @message.Property.Title</span>
                                    </div>
                                }
                            </a>
                        </li>
                    }
                </ul>
            }
            else
            {
                <div class="text-center py-5">
                    <p class="text-variant-3">Không tìm thấy tin nhắn nào</p>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            <ul class="wd-navigation mt-4">
                @if (ViewBag.CurrentPage > 1)
                {
                    <li>
                        <a href="?page=@(ViewBag.CurrentPage - 1)&searchString=@ViewBag.SearchString&isRead=@ViewBag.IsRead" class="nav-item">
                            <i class="icon icon-arr-l"></i>
                        </a>
                    </li>
                }
                @for (int i = 1; i <= ViewBag.TotalPages; i++)
                {
                    if (i == ViewBag.CurrentPage)
                    {
                        <li><a href="#" class="nav-item active">@i</a></li>
                    }
                    else if (i <= 3 || i > ViewBag.TotalPages - 3 || (i >= ViewBag.CurrentPage - 1 && i <= ViewBag.CurrentPage + 1))
                    {
                        <li>
                            <a href="?page=@i&searchString=@ViewBag.SearchString&isRead=@ViewBag.IsRead" class="nav-item">@i</a>
                        </li>
                    }
                    else if (i == 4 || i == ViewBag.TotalPages - 3)
                    {
                        <li><a href="#" class="nav-item">...</a></li>
                    }
                }
                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                {
                    <li>
                        <a href="?page=@(ViewBag.CurrentPage + 1)&searchString=@ViewBag.SearchString&isRead=@ViewBag.IsRead" class="nav-item">
                            <i class="icon icon-arr-r"></i>
                        </a>
                    </li>
                }
            </ul>
        }
    </div>
    <div class="footer-dashboard">
        <p>Copyright © 2024 Home Lengo</p>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle filter dropdown
            $('.nice-select .list .option').on('click', function() {
                var value = $(this).data('value');
                $('#isRead').val(value || '');
                $('#filterForm').submit();
            });
            
            // Handle search on Enter key
            $('.wd-filter input[name="searchString"]').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $(this).closest('form').submit();
                }
            });
            
            // Mark message as read when clicked
            $('.mess-item .mess-content-link').on('click', function(e) {
                var messageItem = $(this).closest('.mess-item');
                if (messageItem.hasClass('unread')) {
                    // The server will mark it as read when viewing details
                    // But we can update the UI immediately for better UX
                    messageItem.removeClass('unread');
                    messageItem.find('.unread-badge').remove();
                }
            });
        });
    </script>
    
    <style>
        .mess-box {
            margin-bottom: 30px;
        }
        
        .list-mess {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .mess-item {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .mess-item:hover {
            background-color: #f8f9fa;
        }
        
        .mess-item.unread {
            background-color: #f0f7ff;
            border-left: 3px solid #1563df;
        }
        
        .mess-item:last-child {
            border-bottom: none;
        }
        
        .mess-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .mess-item .user-box {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .mess-item .user-box .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .mess-item .user-box .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .mess-item .user-box .content {
            flex: 1;
        }
        
        .mess-item .user-box .name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .unread-badge {
            width: 8px;
            height: 8px;
            background-color: #1563df;
            border-radius: 50%;
            display: inline-block;
        }
        
        .mess-actions {
            position: relative;
        }
        
        .btn-action {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .btn-action:hover {
            background-color: #e5e5e5;
        }
        
        .mess-content-link {
            display: block;
            text-decoration: none;
            color: inherit;
            cursor: pointer;
        }
        
        .mess-content-link:hover {
            text-decoration: none;
            color: inherit;
        }
        
        .mess-subject {
            color: #333;
            margin-bottom: 8px;
        }
        
        .mess-item p {
            margin: 0;
            color: #666;
            line-height: 1.6;
        }
        
        .mess-property {
            display: flex;
            align-items: center;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e5e5;
        }
        
        .mess-property .icon {
            color: #1563df;
        }
        
        .dropdown-menu {
            min-width: 180px;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 8px 16px;
        }
        
        .dropdown-item svg {
            margin-right: 8px;
        }
        
        .dropdown-item.text-danger {
            color: #dc3545 !important;
        }
        
        .dropdown-item.text-danger:hover {
            background-color: #f8d7da;
        }
        
        @@media (max-width: 768px) {
            .mess-item-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .mess-actions {
                align-self: flex-end;
            }
        }
    </style>
}
