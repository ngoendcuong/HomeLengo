@* Areas/RealEstateAdmin/Views/Reviews/Index.cshtml *@
@model IEnumerable<dynamic>
@{
    Layout = "~/Areas/RealEstateAdmin/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Đánh giá - Bình luận";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Quản lý Đánh giá & Bình luận</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/RealEstateAdmin/dashboard">Home</a></li>
                    <li class="breadcrumb-item active">Đánh giá</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">
        <!-- Thống kê -->
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="info-box bg-info">
                    <span class="info-box-icon"><i class="fas fa-comments"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Tổng đánh giá</span>
                        <span class="info-box-number">@ViewBag.TotalReviews</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-success">
                    <span class="info-box-icon"><i class="fas fa-eye"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Hiển thị</span>
                        <span class="info-box-number">@ViewBag.ApprovedReviews</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-secondary">
                    <span class="info-box-icon"><i class="fas fa-eye-slash"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Đã ẩn</span>
                        <span class="info-box-number">@ViewBag.PendingReviews</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-box bg-danger">
                    <span class="info-box-icon"><i class="fas fa-star"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Đánh giá TB</span>
                        <span class="info-box-number">@ViewBag.AvgRating/5</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Danh sách Đánh giá</h3>
            </div>

            <div class="card-body">
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                }

                <!-- Filter -->
                <form method="get" action="/RealEstateAdmin/Reviews" id="filterForm">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" name="searchString" class="form-control" placeholder="Tìm kiếm..." value="@ViewBag.SearchString">
                        </div>
                        <div class="col-md-2">
                            <select name="status" class="form-control" onchange="document.getElementById('filterForm').submit();">
                                <option value="">Tất cả trạng thái</option>
                                <option value="approved" selected="@(ViewBag.Status == "approved")">Hiển thị</option>
                                <option value="pending" selected="@(ViewBag.Status == "pending")">Đã ẩn</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select name="rating" class="form-control" onchange="document.getElementById('filterForm').submit();">
                                <option value="">Tất cả rating</option>
                                <option value="5" selected="@(ViewBag.Rating == 5)">⭐⭐⭐⭐⭐ 5 sao</option>
                                <option value="4" selected="@(ViewBag.Rating == 4)">⭐⭐⭐⭐ 4 sao</option>
                                <option value="3" selected="@(ViewBag.Rating == 3)">⭐⭐⭐ 3 sao</option>
                                <option value="2" selected="@(ViewBag.Rating == 2)">⭐⭐ 2 sao</option>
                                <option value="1" selected="@(ViewBag.Rating == 1)">⭐ 1 sao</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-info"><i class="fas fa-search"></i> Tìm</button>
                            @if (!string.IsNullOrEmpty(ViewBag.SearchString) || !string.IsNullOrEmpty(ViewBag.Status) || ViewBag.Rating != null)
                            {
                                <a href="/RealEstateAdmin/Reviews" class="btn btn-secondary ml-1"><i class="fas fa-times"></i> Xóa bộ lọc</a>
                            }
                        </div>
                    </div>
                </form>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="bg-light">
                            <tr>
                                <th width="5%">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="checkAll">
                                        <label class="custom-control-label" for="checkAll"></label>
                                    </div>
                                </th>
                                <th width="12%">Người dùng</th>
                                <th width="18%">Bất động sản</th>
                                <th width="12%">Môi giới</th>
                                <th width="8%">Rating</th>
                                <th width="25%">Nội dung</th>
                                <th width="10%">Trạng thái</th>
                                <th width="10%">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var review in Model)
                            {
                                var isVisible = (review.Status == "Đã duyệt"); // đang hiển thị
                                <tr>
                                    <td>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="check@(review.Id)">
                                            <label class="custom-control-label" for="check@(review.Id)"></label>
                                        </div>
                                    </td>
                                    <td>
                                        <strong>@review.User</strong><br>
                                        <small class="text-muted">@review.CreatedDate</small>
                                    </td>
                                    <td>
                                        @if (review.PropertyId > 0)
                                        {
                                            <a href="/Property/Details/@review.PropertyId" target="_blank" class="text-primary">@review.Property</a>
                                        }
                                        else
                                        {
                                            <span>@review.Property</span>
                                        }
                                    </td>
                                    <td>@review.Agent</td>
                                    <td class="text-center">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= review.Rating)
                                            {
                                                <i class="fas fa-star text-warning"></i>
                                            }
                                            else
                                            {
                                                <i class="far fa-star text-warning"></i>
                                            }
                                        }
                                        <br>
                                        <span class="badge badge-info">@review.Rating/5</span>
                                    </td>
                                    <td>
                                        <p class="mb-0" style="font-size: 13px;">@review.Comment</p>
                                    </td>
                                    <td>
                                        @if (isVisible)
                                        {
                                            <span class="badge badge-success">Hiển thị</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-secondary">Đã ẩn</span>
                                        }
                                    </td>
                                    <td>
                                        @if (review.Status == "Đã duyệt")
                                        {
                                            <!-- Đang hiển thị -> Ẩn -->
                                            <form asp-area="RealEstateAdmin"
                                                  asp-controller="Reviews"
                                                  asp-action="Hide"
                                                  method="post"
                                                  style="display:inline;"
                                                  onsubmit="return confirm('Bạn có chắc chắn muốn ẩn đánh giá này?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@review.Id" />
                                                <button type="submit" class="btn btn-sm btn-secondary btn-block" title="Ẩn">
                                                    <i class="fas fa-eye-slash"></i> Ẩn
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <!-- Đang ẩn -> Hiện -->
                                            <form asp-area="RealEstateAdmin"
                                                  asp-controller="Reviews"
                                                  asp-action="Show"
                                                  method="post"
                                                  style="display:inline;"
                                                  onsubmit="return confirm('Bạn có chắc chắn muốn hiển thị đánh giá này?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@review.Id" />
                                                <button type="submit" class="btn btn-sm btn-success btn-block" title="Hiện">
                                                    <i class="fas fa-eye"></i> Hiện
                                                </button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination (UI demo) -->
                <div class="row mt-3">
                    <div class="col-md-12">
                        <ul class="pagination pagination-sm float-right">
                            <li class="page-item"><a class="page-link" href="#">«</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">»</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Check all
        $('#checkAll').change(function () {
            $('input[type="checkbox"]').prop('checked', $(this).prop('checked'));
        });
    </script>
}
