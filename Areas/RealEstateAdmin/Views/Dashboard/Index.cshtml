@* Views/Admin/Dashboard/Index.cshtml *@
@{
    Layout = "~/Areas/RealEstateAdmin/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Dashboard";
}

<!-- Content Header -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Dashboard</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Main content -->
<section class="content">
    <div class="container-fluid">

        <!-- Stat Boxes -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-info">
                    <div class="inner">
                        <h3>@ViewBag.TotalProperties</h3>
                        <p>Tổng Bất động sản</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <a href="/RealEstateAdmin/properties" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-success">
                    <div class="inner">
                        <h3>@ViewBag.ActiveProperties</h3>
                        <p>Đang bán</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <a href="/RealEstateAdmin/properties" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-warning">
                    <div class="inner">
                        <h3 style="color: white;">@ViewBag.PendingProperties</h3>
                        <p style="color: white;">Bài viết</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <a href="/RealEstateAdmin/blog" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-danger">
                    <div class="inner">
                        <h3>@ViewBag.RentProperties</h3>
                        <p>Cho thuê</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <a href="/RealEstateAdmin/properties" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Second Row -->
        <div class="row">
            <div class="col-lg-3 col-6">
                <div class="small-box bg-primary">
                    <div class="inner">
                        <h3>@ViewBag.TotalAgents</h3>
                        <p>Môi giới</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <a href="/RealEstateAdmin/agents" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-3 col-6">
                <div class="small-box bg-secondary">
                    <div class="inner">
                        <h3>@ViewBag.TotalUsers</h3>
                        <p>Người dùng</p>
                    </div>
                    <div class="icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <a href="/RealEstateAdmin/users" class="small-box-footer">
                        Xem chi tiết <i class="fas fa-arrow-circle-right"></i>
                    </a>
                </div>
            </div>

            <div class="col-lg-6 col-12">
                <div class="info-box @(ViewBag.IsGrowthPositive ? "bg-gradient-success" : "bg-gradient-danger")">
                    <span class="info-box-icon"><i class="fas fa-dollar-sign"></i></span>
                    <div class="info-box-content">
                        <span class="info-box-text">Doanh thu tháng này</span>
                        <h3 class="info-box-number">@string.Format("{0:N0}", ViewBag.MonthRevenue) VNĐ</h3>
        
                        <div class="progress">
                            @* Thanh chạy hiển thị trực quan % tăng trưởng (giới hạn tối đa 100%) *@
                            <div class="progress-bar" style="width: @(Math.Min(Math.Abs(ViewBag.GrowthPercent), 100))%"></div>
                        </div>
        
                        <span class="progress-description">
                            @if (ViewBag.IsGrowthPositive) {
                                <i class="fas fa-arrow-up"></i> <span>Tăng </span>
                            } else {
                                <i class="fas fa-arrow-down"></i> <span>Giảm </span>
                            }
                            @Math.Abs(ViewBag.GrowthPercent)% so với tháng trước
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-line mr-1"></i>
                            Doanh thu 6 tháng gần đây
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="revenueChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-chart-pie mr-1"></i>
                            Tin đăng theo loại
                        </h3>
                    </div>
                    <div class="card-body">
                        <canvas id="propertyTypeChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        // Revenue Chart - DỮ LIỆU THỰC TẾ TỪ DATABASE
        const revenueCtx = document.getElementById('revenueChart').getContext('2d');
        
        // Nhận dữ liệu từ ViewBag
        const revLabels = @Html.Raw(Json.Serialize(ViewBag.RevenueLabels));
        const revData = @Html.Raw(Json.Serialize(ViewBag.RevenueData));

        new Chart(revenueCtx, {
            type: 'line',
            data: {
                labels: revLabels, // ['Tháng 8/2025', 'Tháng 9/2025', ...]
                datasets: [{
                    label: 'Doanh thu (VNĐ)',
                    data: revData, // [15000000, 22000000, ...]
                    borderColor: 'rgba(60,141,188,0.8)',
                    backgroundColor: 'rgba(60,141,188,0.2)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 5,
                    pointBackgroundColor: '#3c8dbc'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true },
                    // Hiển thị định dạng tiền tệ khi di chuột vào điểm dữ liệu
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            // Định dạng trục Y (Ví dụ: 10.000.000đ)
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' đ';
                            }
                        }
                    }
                }
            }
        });

                // Property Type Chart
        const propertyTypeCtx = document.getElementById('propertyTypeChart').getContext('2d');

        // Nhận dữ liệu động từ Controller
        const dbLabels = @Html.Raw(Json.Serialize(ViewBag.PropertyTypeLabels));
        const dbData = @Html.Raw(Json.Serialize(ViewBag.PropertyTypeData));

        new Chart(propertyTypeCtx, {
            type: 'doughnut',
            data: {
                labels: dbLabels, // Tên các loại: Căn hộ, Nhà phố, Biệt thự...
                datasets: [{
                    data: dbData, // Số lượng tin tương ứng
                    backgroundColor: [
                        '#3498db', // Blue
                        '#e74c3c', // Red
                        '#f1c40f', // Yellow
                        '#2ecc71', // Green
                        '#9b59b6', // Purple
                        '#e67e22', // Orange
                        '#1abc9c'  // Teal
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12
                        }
                    }
                }
            }
        });
    </script>
}