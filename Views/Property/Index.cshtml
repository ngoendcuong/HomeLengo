@model IEnumerable<HomeLengo.Models.Property>
@{
    ViewData["Title"] = "Danh Sách Bất Động Sản";
    var propertyTypes = ViewBag.PropertyTypes as IEnumerable<HomeLengo.Models.PropertyType>;
    var amenities = ViewBag.Amenities as IEnumerable<HomeLengo.Models.Amenity>;
    var selectedPropertyTypeId = ViewBag.SelectedPropertyTypeId as int?;
    var selectedPropertyTypeName = ViewBag.SelectedPropertyTypeName as string ?? "Loại bất động sản";
    var totalCount = ViewBag.TotalCount as int? ?? 0;
    var latestProperties = ViewBag.LatestProperties as IEnumerable<HomeLengo.Models.Property> ?? new List<HomeLengo.Models.Property>();
    var keyword = ViewBag.Keyword as string ?? "";
    var location = ViewBag.Location as string ?? "";
    var bedrooms = ViewBag.Bedrooms as int?;
    var bathrooms = ViewBag.Bathrooms as int?;
    var bedroomsValue = bedrooms ?? 0;
    var bathroomsValue = bathrooms ?? 0;
    var minPrice = ViewBag.MinPrice as decimal?;
    var maxPrice = ViewBag.MaxPrice as decimal?;
    var minSize = ViewBag.MinSize as decimal?;
    var maxSize = ViewBag.MaxSize as decimal?;
    var selectedAmenities = ViewBag.SelectedAmenities as int[] ?? Array.Empty<int>();
    var currentPage = ViewBag.CurrentPage as int? ?? 1;
    var totalPages = ViewBag.TotalPages as int? ?? 1;
    var pageSize = ViewBag.PageSize as int? ?? 10;
    var sortBy = ViewBag.SortBy as string ?? "default";
    var statusId = ViewBag.StatusId as int?;
    
    // Hàm format giá theo triệu/tỷ
    Func<decimal, string> FormatPrice = (price) => {
        if (price >= 1000000000)
        {
            var ty = price / 1000000000;
            return ty.ToString("N1").TrimEnd('0').TrimEnd('.') + " tỷ";
        }
        else if (price >= 1000000)
        {
            var trieu = price / 1000000;
            return trieu.ToString("N1").TrimEnd('0').TrimEnd('.') + " triệu";
        }
        else
        {
            return price.ToString("N0") + " VND";
        }
    };
}

<section class="flat-section flat-recommended flat-sidebar">
    <div class="container">
        <div class="box-title-listing">
            <div class="box-left">
                <h3 class="fw-8">Danh Sách Bất Động Sản</h3>
                <p class="text">Hiện có @totalCount bất động sản.</p>
            </div>
            <div class="box-filter-tab">
                @{
                    // Build query string for sorting and page size
                    var filterQueryParams = new System.Text.StringBuilder();
                    if (!string.IsNullOrEmpty(keyword)) filterQueryParams.Append($"&keyword={Uri.EscapeDataString(keyword)}");
                    if (!string.IsNullOrEmpty(location)) filterQueryParams.Append($"&location={Uri.EscapeDataString(location)}");
                    if (statusId.HasValue) filterQueryParams.Append($"&statusId={statusId.Value}");
                    if (selectedPropertyTypeId.HasValue) filterQueryParams.Append($"&propertyTypeId={selectedPropertyTypeId.Value}");
                    if (bedrooms.HasValue) filterQueryParams.Append($"&bedrooms={bedrooms.Value}");
                    if (bathrooms.HasValue) filterQueryParams.Append($"&bathrooms={bathrooms.Value}");
                    if (minPrice.HasValue) filterQueryParams.Append($"&minPrice={minPrice.Value}");
                    if (maxPrice.HasValue) filterQueryParams.Append($"&maxPrice={maxPrice.Value}");
                    if (minSize.HasValue) filterQueryParams.Append($"&minSize={minSize.Value}");
                    if (maxSize.HasValue) filterQueryParams.Append($"&maxSize={maxSize.Value}");
                    if (selectedAmenities != null && selectedAmenities.Length > 0)
                    {
                        foreach (var amenityId in selectedAmenities)
                        {
                            filterQueryParams.Append($"&amenities={amenityId}");
                        }
                    }
                    var filterQueryString = filterQueryParams.ToString();
                }
                <div class="nice-select select-filter list-sort" tabindex="0">
                    <span class="current">@(sortBy == "default" ? "Sắp xếp (Mặc định)" : sortBy == "newest" ? "Mới nhất" : sortBy == "oldest" ? "Cũ nhất" : sortBy == "price-low" ? "Giá thấp đến cao" : "Giá cao đến thấp")</span>
                    <ul class="list">  
                        <li data-value="default" class="option @(sortBy == "default" ? "selected" : "")">
                            <a href="?sortBy=default&pageSize=@pageSize@filterQueryString" style="text-decoration: none; color: inherit;">Sắp xếp (Mặc định)</a>
                        </li>
                        <li data-value="newest" class="option @(sortBy == "newest" ? "selected" : "")">
                            <a href="?sortBy=newest&pageSize=@pageSize@filterQueryString" style="text-decoration: none; color: inherit;">Mới nhất</a>
                        </li>
                        <li data-value="oldest" class="option @(sortBy == "oldest" ? "selected" : "")">
                            <a href="?sortBy=oldest&pageSize=@pageSize@filterQueryString" style="text-decoration: none; color: inherit;">Cũ nhất</a>
                        </li>
                        <li data-value="price-low" class="option @(sortBy == "price-low" ? "selected" : "")">
                            <a href="?sortBy=price-low&pageSize=@pageSize@filterQueryString" style="text-decoration: none; color: inherit;">Giá thấp đến cao</a>
                        </li>
                        <li data-value="price-high" class="option @(sortBy == "price-high" ? "selected" : "")">
                            <a href="?sortBy=price-high&pageSize=@pageSize@filterQueryString" style="text-decoration: none; color: inherit;">Giá cao đến thấp</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xl-4 col-lg-5">
                <div class="widget-sidebar fixed-sidebar">
                    <div class="flat-tab flat-tab-form widget-filter-search widget-box">
                        <ul class="nav-tab-form" role="tablist">
                            <li class="nav-tab-item" role="presentation">
                                <a href="#forRent"
                                   class="nav-link-item @(statusId == 2 ? "active" : "")"
                                   data-bs-toggle="tab">
                                    Cho Thuê
                                </a>
                            </li>
                            <li class="nav-tab-item" role="presentation">
                                <a href="#forSale"
                                   class="nav-link-item @(statusId == 1 ? "active" : "")"
                                   data-bs-toggle="tab">
                                    Bán
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade @(statusId == 2 ? "active show" : "")"
                                 id="forRent" role="tabpanel">

                                <div class="form-sl">
                                    <form method="get" action="/Property">
                                        <input type="hidden" name="page" value="1" />
                                        <input type="hidden" name="statusId" value="2" />
                                        <div class="wd-filter-select">
                                            <div class="inner-group">
                                                <div class="box">
                                                    <div class="form-style">
                                                        <input type="text" class="form-control" placeholder="Nhập từ khóa..." name="keyword" value="@keyword">
                                                    </div>
                                                    <div class="form-style">
                                                        <div class="group-ip ip-icon">
                                                            <input type="text" class="form-control" placeholder="Địa điểm" name="location" value="@location">
                                                            <a href="#" class="icon-right icon-location"></a>
                                                        </div>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="propertyTypeId" class="form-control">
                                                            <option value="">@selectedPropertyTypeName</option>
                                                            @if (propertyTypes != null)
                                                            {
                                                                @foreach (var pt in propertyTypes)
                                                                {
                                                                    @if (selectedPropertyTypeId == pt.PropertyTypeId)
                                                                    {
                                                                        <option value="@pt.PropertyTypeId" selected>@pt.Name</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@pt.PropertyTypeId">@pt.Name</option>
                                                                    }
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="bedrooms" class="form-control">
                                                            <option value="">Phòng ngủ</option>
                                                            @if (bedroomsValue == 1) { <option value="1" selected>1</option> } else { <option value="1">1</option> }
                                                            @if (bedroomsValue == 2) { <option value="2" selected>2</option> } else { <option value="2">2</option> }
                                                            @if (bedroomsValue == 3) { <option value="3" selected>3</option> } else { <option value="3">3</option> }
                                                            @if (bedroomsValue == 4) { <option value="4" selected>4</option> } else { <option value="4">4</option> }
                                                            @if (bedroomsValue == 5) { <option value="5" selected>5+</option> } else { <option value="5">5+</option> }
                                                        </select>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="bathrooms" class="form-control">
                                                            <option value="">Phòng tắm</option>
                                                            @if (bathroomsValue == 1) { <option value="1" selected>1</option> } else { <option value="1">1</option> }
                                                            @if (bathroomsValue == 2) { <option value="2" selected>2</option> } else { <option value="2">2</option> }
                                                            @if (bathroomsValue == 3) { <option value="3" selected>3</option> } else { <option value="3">3</option> }
                                                            @if (bathroomsValue == 4) { <option value="4" selected>4</option> } else { <option value="4">4</option> }
                                                            @if (bathroomsValue == 5) { <option value="5" selected>5+</option> } else { <option value="5">5+</option> }
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="box">
                                                    <div class="form-style widget-price">
                                                        <div class="box-title-price">
                                                            <span class="title-price fw-6">Giá:</span>
                                                            <div class="caption-price">
                                                                <span id="slider-range-value1" class="fw-6">@FormatPrice(minPrice ?? 1000000000)</span>
                                                                <span class="fw-6"> - </span>
                                                                <span id="slider-range-value2" class="fw-6">@FormatPrice(maxPrice ?? 20000000000)</span>
                                                            </div>
                                                        </div>
                                                        <div id="slider-range"></div>
                                                        <div class="slider-labels">
                                                            @if (minPrice.HasValue)
                                                            {
                                                                <input type="hidden" name="minPrice" id="minPrice" value="@minPrice.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="minPrice" id="minPrice" value="">
                                                            }
                                                            @if (maxPrice.HasValue)
                                                            {
                                                                <input type="hidden" name="maxPrice" id="maxPrice" value="@maxPrice.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="maxPrice" id="maxPrice" value="">
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="form-style widget-price wd-price-2">
                                                        <div class="box-title-price">
                                                            <span class="title-price fw-6">Diện tích:</span>
                                                            <div class="caption-price">
                                                                <span id="slider-range-value01" class="fw-6">@((minSize ?? 0).ToString("N0")) m²</span>
                                                                <span class="fw-6"> đến </span>
                                                                <span id="slider-range-value02" class="fw-6">@((maxSize ?? 500).ToString("N0")) m²</span>
                                                            </div>
                                                        </div>
                                                        <div id="slider-range2"></div>
                                                        <div class="slider-labels">
                                                            @if (minSize.HasValue)
                                                            {
                                                                <input type="hidden" name="minSize" id="minSize" value="@minSize.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="minSize" id="minSize" value="">
                                                            }
                                                            @if (maxSize.HasValue)
                                                            {
                                                                <input type="hidden" name="maxSize" id="maxSize" value="@maxSize.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="maxSize" id="maxSize" value="">
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="box">
                                                    <div class="form-style wd-amenities">
                                                        <div class="group-checkbox">
                                                            <h6 class="title text-black-2">Tiện ích:</h6>
                                                            <div class="group-amenities">
                                                                @if (amenities != null)
                                                                {
                                                                    @foreach (var amenity in amenities)
                                                                    {
                                                                        var isChecked = selectedAmenities.Contains(amenity.AmenityId);
                                                                        <fieldset class="amenities-item">
                                                                            <input type="checkbox" class="tf-checkbox style-1" id="amenity_@amenity.AmenityId" name="amenities" value="@amenity.AmenityId" @(isChecked ? "checked" : "")> 
                                                                            <label for="amenity_@amenity.AmenityId" class="text-cb-amenities">@amenity.Name</label>
                                                                        </fieldset>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-style">
                                                <button type="submit" class="tf-btn btn-view primary hover-btn-view">Tìm Kiếm <span class="icon icon-arrow-right2"></span></button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="tab-pane fade @(statusId == 1 ? "active show" : "")"
                                 id="forSale" role="tabpanel">

                                <div class="form-sl">
                                    <form method="get" action="/Property">
                                        <input type="hidden" name="page" value="1" />
                                        <input type="hidden" name="statusId" value="1" />
                                        <div class="wd-filter-select">
                                            <div class="inner-group">
                                                <div class="box">
                                                    <div class="form-style">
                                                        <input type="text" class="form-control" placeholder="Nhập từ khóa..." name="keyword" value="@keyword">
                                                    </div>
                                                    <div class="form-style">
                                                        <div class="group-ip ip-icon">
                                                            <input type="text" class="form-control" placeholder="Địa điểm" name="location" value="@location">
                                                            <a href="#" class="icon-right icon-location"></a>
                                                        </div>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="propertyTypeId" class="form-control">
                                                            <option value="">@selectedPropertyTypeName</option>
                                                            @if (propertyTypes != null)
                                                            {
                                                                @foreach (var pt in propertyTypes)
                                                                {
                                                                    @if (selectedPropertyTypeId == pt.PropertyTypeId)
                                                                    {
                                                                        <option value="@pt.PropertyTypeId" selected>@pt.Name</option>
                                                                    }
                                                                    else
                                                                    {
                                                                        <option value="@pt.PropertyTypeId">@pt.Name</option>
                                                                    }
                                                                }
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="bedrooms" class="form-control">
                                                            <option value="">Phòng ngủ</option>
                                                            @if (bedroomsValue == 1) { <option value="1" selected>1</option> } else { <option value="1">1</option> }
                                                            @if (bedroomsValue == 2) { <option value="2" selected>2</option> } else { <option value="2">2</option> }
                                                            @if (bedroomsValue == 3) { <option value="3" selected>3</option> } else { <option value="3">3</option> }
                                                            @if (bedroomsValue == 4) { <option value="4" selected>4</option> } else { <option value="4">4</option> }
                                                            @if (bedroomsValue == 5) { <option value="5" selected>5+</option> } else { <option value="5">5+</option> }
                                                        </select>
                                                    </div>
                                                    <div class="form-style box-select">
                                                        <select name="bathrooms" class="form-control">
                                                            <option value="">Phòng tắm</option>
                                                            @if (bathroomsValue == 1) { <option value="1" selected>1</option> } else { <option value="1">1</option> }
                                                            @if (bathroomsValue == 2) { <option value="2" selected>2</option> } else { <option value="2">2</option> }
                                                            @if (bathroomsValue == 3) { <option value="3" selected>3</option> } else { <option value="3">3</option> }
                                                            @if (bathroomsValue == 4) { <option value="4" selected>4</option> } else { <option value="4">4</option> }
                                                            @if (bathroomsValue == 5) { <option value="5" selected>5+</option> } else { <option value="5">5+</option> }
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="box">
                                                    <div class="form-style widget-price">
                                                        <div class="box-title-price">
                                                            <span class="title-price fw-6">Giá:</span>
                                                            <div class="caption-price">
                                                                <span id="slider-range-value1-sale" class="fw-6">@FormatPrice(minPrice ?? 1000000000)</span>
                                                                <span class="fw-6"> - </span>
                                                                <span id="slider-range-value2-sale" class="fw-6">@FormatPrice(maxPrice ?? 20000000000)</span>
                                                            </div>
                                                        </div>
                                                        <div id="slider-range-sale"></div>
                                                        <div class="slider-labels">
                                                            @if (minPrice.HasValue)
                                                            {
                                                                <input type="hidden" name="minPrice" id="minPriceSale" value="@minPrice.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="minPrice" id="minPriceSale" value="">
                                                            }
                                                            @if (maxPrice.HasValue)
                                                            {
                                                                <input type="hidden" name="maxPrice" id="maxPriceSale" value="@maxPrice.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="maxPrice" id="maxPriceSale" value="">
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="form-style widget-price wd-price-2">
                                                        <div class="box-title-price">
                                                            <span class="title-price fw-6">Diện tích:</span>
                                                            <div class="caption-price">
                                                                <span id="slider-range-value01-sale" class="fw-6">@((minSize ?? 0).ToString("N0")) m²</span>
                                                                <span class="fw-6"> đến </span>
                                                                <span id="slider-range-value02-sale" class="fw-6">@((maxSize ?? 500).ToString("N0")) m²</span>
                                                            </div>
                                                        </div>
                                                        <div id="slider-range2-sale"></div>
                                                        <div class="slider-labels">
                                                            @if (minSize.HasValue)
                                                            {
                                                                <input type="hidden" name="minSize" id="minSizeSale" value="@minSize.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="minSize" id="minSizeSale" value="">
                                                            }
                                                            @if (maxSize.HasValue)
                                                            {
                                                                <input type="hidden" name="maxSize" id="maxSizeSale" value="@maxSize.Value">
                                                            }
                                                            else
                                                            {
                                                                <input type="hidden" name="maxSize" id="maxSizeSale" value="">
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="box">
                                                    <div class="form-style wd-amenities">
                                                        <div class="group-checkbox">
                                                            <h6 class="title text-black-2">Tiện ích:</h6>
                                                            <div class="group-amenities">
                                                                @if (amenities != null)
                                                                {
                                                                    @foreach (var amenity in amenities)
                                                                    {
                                                                        var isChecked = selectedAmenities.Contains(amenity.AmenityId);
                                                                        <fieldset class="amenities-item">
                                                                            <input type="checkbox" class="tf-checkbox style-1" id="amenity_sale_@amenity.AmenityId" name="amenities" value="@amenity.AmenityId" @(isChecked ? "checked" : "")> 
                                                                            <label for="amenity_sale_@amenity.AmenityId" class="text-cb-amenities">@amenity.Name</label>
                                                                        </fieldset>
                                                                    }
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-style">
                                                <button type="submit" class="tf-btn btn-view primary hover-btn-view">Tìm Kiếm <span class="icon icon-arrow-right2"></span></button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="widget-box box-latest-property">
                        <h5 class="fw-6 title">Bất Động Sản Mới Nhất</h5>
                        <ul>
                            @foreach (var latest in latestProperties)
                            {
                                var latestPhoto = latest.PropertyPhotos?.OrderByDescending(p => p.IsPrimary == true).ThenBy(p => p.SortOrder ?? 0).FirstOrDefault();
                                <li class="latest-property-item">
                                    <a href="/Property/Details/@latest.PropertyId" class="images-style">
                                        @if (latestPhoto != null)
                                        {
                                            var photoPath = latestPhoto.FilePath?.StartsWith("~/") == true 
                                                ? latestPhoto.FilePath 
                                                : $"~/assets/images/home/{latestPhoto.FilePath}";
                                            <img src="@Url.Content(photoPath)" alt="@latest.Title">
                                        }
                                        else
                                        {
                                            <img src="@Url.Content("~/assets/images/home/default.jpg")" alt="@latest.Title">
                                        }
                                    </a>
                                    <div class="content">
                                        <div class="text-capitalize text-btn">
                                            <a href="/Property/Details/@latest.PropertyId" class="link">@latest.Title</a>
                                        </div>
                                        <ul class="meta-list mt-6">
                                            @if (latest.Bedrooms.HasValue)
                                            {
                                                <li class="item">
                                                    <i class="icon icon-bed"></i>
                                                    <span class="text-variant-1">Phòng ngủ:</span>
                                                    <span class="fw-6">@latest.Bedrooms</span>
                                                </li>
                                            }
                                            @if (latest.Bathrooms.HasValue)
                                            {
                                                <li class="item">
                                                    <i class="icon icon-bath"></i>
                                                    <span class="text-variant-1">Phòng tắm:</span>
                                                    <span class="fw-6">@latest.Bathrooms</span>
                                                </li>
                                            }
                                            @if (latest.Area.HasValue)
                                            {
                                                <li class="item">
                                                    <i class="icon "></i>
                                                    <span class="text-variant-1">Diện tích:</span>
                                                    <span class="fw-6">@latest.Area m²</span>
                                                </li>
                                            }
                                        </ul>
                                        <div class="mt-10 text-btn">@string.Format("{0:N0} {1}", latest.Price, latest.Currency ?? "VND")</div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-xl-8 col-lg-7 flat-animate-tab">
                <div class="tab-content">
                    <div class="tab-pane active show" id="gridLayout" role="tabpanel">
                        <div class="row">
                            @if (Model != null && Model.Any())
                            {
                                @foreach (var item in Model)
                                {
                                    var primaryPhoto = item.PropertyPhotos?
                                        .OrderByDescending(p => p.IsPrimary == true)
                                        .ThenBy(p => p.SortOrder ?? 0)
                                        .FirstOrDefault();

                                    <div class="col-md-6">
                                        <div class="homelengo-box">
                                            <div class="archive-top">
                                                <a href="/Property/Details/@item.PropertyId" class="images-group">
                                                    <div class="images-style">
                                                        @if (primaryPhoto != null)
                                                        {
                                                            var photoPath = primaryPhoto.FilePath?.StartsWith("~/") == true 
                                                                ? primaryPhoto.FilePath 
                                                                : $"~/assets/images/home/{primaryPhoto.FilePath}";
                                                            <img class="lazyload"
                                                                 data-src="@Url.Content(photoPath)"
                                                                 src="@Url.Content(photoPath)"
                                                                 alt="@item.Title" />
                                                        }
                                                        else
                                                        {
                                                            <img class="lazyload"
                                                                 data-src="@Url.Content("~/assets/images/home/default.jpg")"
                                                                 src="@Url.Content("~/assets/images/home/default.jpg")"
                                                                 alt="@item.Title" />
                                                        }
                                                    </div>
                                                    <div class="top">
                                                        <ul class="d-flex gap-6">
                                                            @if (item.IsFeatured == true)
                                                            {
                                                                <li class="flag-tag primary">Nổi bật</li>
                                                            }
                                                            <li class="flag-tag style-1">@item.Status?.Name</li>
                                                        </ul>
                                                    </div>
                                                    <div class="bottom">
                                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M10 7C10 7.53043 9.78929 8.03914 9.41421 8.41421C9.03914 8.78929 8.53043 9 8 9C7.46957 9 6.96086 8.78929 6.58579 8.41421C6.21071 8.03914 6 7.53043 6 7C6 6.46957 6.21071 5.96086 6.58579 5.58579C6.96086 5.21071 7.46957 5 8 5C8.53043 5 9.03914 5.21071 9.41421 5.58579C9.78929 5.96086 10 6.46957 10 7Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                            <path d="M13 7C13 11.7613 8 14.5 8 14.5C8 14.5 3 11.7613 3 7C3 5.67392 3.52678 4.40215 4.46447 3.46447C5.40215 2.52678 6.67392 2 8 2C9.32608 2 10.5979 2.52678 11.5355 3.46447C12.4732 4.40215 13 5.67392 13 7Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                        </svg>
                                                        @item.Address
                                                        @if (!string.IsNullOrEmpty(item.Neighborhood?.Name))
                                                        {
                                                            <span>, @item.Neighborhood.Name</span>
                                                        }
                                                    </div>
                                                </a>
                                            </div>
                                            <div class="archive-bottom">
                                                <div class="content-top">
                                                    <h6 class="text-capitalize">
                                                        <a href="/Property/Details/@item.PropertyId" class="link">@item.Title</a>
                                                    </h6>
                                                    <ul class="meta-list">
                                                        @if (item.Bedrooms.HasValue)
                                                        {
                                                            <li class="item">
                                                                <i class="icon icon-bed"></i>
                                                                <span class="text-variant-1">Phòng ngủ:</span>
                                                                <span class="fw-6">@item.Bedrooms</span>
                                                            </li>
                                                        }
                                                        @if (item.Bathrooms.HasValue)
                                                        {
                                                            <li class="item">
                                                                <i class="icon icon-bath"></i>
                                                                <span class="text-variant-1">Phòng tắm:</span>
                                                                <span class="fw-6">@item.Bathrooms</span>
                                                            </li>
                                                        }
                                                        @if (item.Area.HasValue)
                                                        {
                                                            <li class="item">
                                                                <i class="icon "></i>
                                                                <span class="text-variant-1">Diện tích:</span>
                                                                <span class="fw-6">@item.Area m²</span>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                                <div class="content-bottom">
                                                    <div class="d-flex gap-8 align-items-center">
                                                        <div class="avatar avt-40 round">
                                                            @{
                                                                var avatarFileName = item.Agent?.User?.Avatar;
                                                                var avatarPath = string.IsNullOrEmpty(avatarFileName)
                                                                    ? "~/assets/images/avatar/default-avatar.gif"
                                                                    : $"~/assets/images/avatar/{avatarFileName}";
                                                            }
                                                            <img class="lazyload"
                                                                 data-src="@Url.Content(avatarPath)"
                                                                 src="@Url.Content(avatarPath)"
                                                                 alt="@item.Agent?.AgencyName" />
                                                        </div>
                                                        <span>@(item.Agent?.AgencyName ?? "Chưa có thông tin")</span>
                                                    </div>
                                                    <h6 class="price">
                                                        @string.Format("{0:N0} {1}", item.Price, item.Currency ?? "VND")
                                                    </h6>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col-12">
                                    <div class="text-center py-5">
                                        <p class="text-muted">Không tìm thấy bất động sản nào.</p>
                                    </div>
                                </div>
                            }
                        </div>
                        @{
                            // Build query string for pagination
                            var queryParams = new System.Text.StringBuilder();
                            if (!string.IsNullOrEmpty(keyword)) queryParams.Append($"&keyword={Uri.EscapeDataString(keyword)}");
                            if (!string.IsNullOrEmpty(location)) queryParams.Append($"&location={Uri.EscapeDataString(location)}");
                            if (statusId.HasValue) queryParams.Append($"&statusId={statusId.Value}");
                            if (selectedPropertyTypeId.HasValue) queryParams.Append($"&propertyTypeId={selectedPropertyTypeId.Value}");
                            if (bedrooms.HasValue) queryParams.Append($"&bedrooms={bedrooms.Value}");
                            if (bathrooms.HasValue) queryParams.Append($"&bathrooms={bathrooms.Value}");
                            if (minPrice.HasValue) queryParams.Append($"&minPrice={minPrice.Value}");
                            if (maxPrice.HasValue) queryParams.Append($"&maxPrice={maxPrice.Value}");
                            if (minSize.HasValue) queryParams.Append($"&minSize={minSize.Value}");
                            if (maxSize.HasValue) queryParams.Append($"&maxSize={maxSize.Value}");
                            if (selectedAmenities != null && selectedAmenities.Length > 0)
                            {
                                foreach (var amenityId in selectedAmenities)
                                {
                                    queryParams.Append($"&amenities={amenityId}");
                                }
                            }
                            var queryString = queryParams.ToString();
                        }
                        @if (totalPages > 1)
                        {
                            <div class="pagination-wrapper mt-4">
                                <nav aria-label="Phân trang">
                                    <ul class="pagination justify-content-center">
                                        @if (currentPage > 1)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" href="?page=@(currentPage - 1)&pageSize=@pageSize&sortBy=@sortBy@queryString">Trước</a>
                                            </li>
                                        }
                                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                                        {
                                            <li class="page-item @(i == currentPage ? "active" : "")">
                                                <a class="page-link" href="?page=@i&pageSize=@pageSize&sortBy=@sortBy@queryString">@i</a>
                                            </li>
                                        }
                                        @if (currentPage < totalPages)
                                        {
                                            <li class="page-item">
                                                <a class="page-link" href="?page=@(currentPage + 1)&pageSize=@pageSize&sortBy=@sortBy@queryString">Sau</a>
                                            </li>
                                        }
                                    </ul>
                                </nav>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        $(document).ready(function () {

            /* =========================
               HELPER FUNCTIONS
            ========================== */

            function parseValue(value, defaultValue) {
                if (!value) return defaultValue;
                var cleaned = value.toString().replace(/[^\d]/g, '');
                var parsed = parseInt(cleaned);
                return isNaN(parsed) ? defaultValue : parsed;
            }

            // FORMAT GIÁ THEO CHUẨN VIỆT NAM
            function formatPrice(value) {
                if (isNaN(value)) return '0';
                value = Math.round(value);

                if (value >= 1000000000)
                    return (value / 1000000000).toFixed(1).replace(/\.0$/, '') + ' tỷ';

                if (value >= 1000000)
                    return (value / 1000000).toFixed(0) + ' triệu';

                return value.toLocaleString('vi-VN') + ' VND';
            }

            /* =========================
               RENT SLIDERS (CHO THUÊ)
            ========================== */

            function initRentSliders() {

                /* ===== GIÁ ===== */
                var priceSlider = document.getElementById("slider-range");
                if (priceSlider) {

                    if (priceSlider.noUiSlider)
                        priceSlider.noUiSlider.destroy();

                    noUiSlider.create(priceSlider, {
                        start: [1000000000, 20000000000], // 1 – 20 tỷ
                        connect: true,
                        range: {
                            min: 1000000000,
                            max: 20000000000
                        },
                        step: 100000000
                    });

                    // HIỂN THỊ BAN ĐẦU
                    $("#slider-range-value1").text(formatPrice(1000000000));
                    $("#slider-range-value2").text(formatPrice(20000000000));

                    priceSlider.noUiSlider.on('update', function (values) {
                        var min = Math.round(values[0]);
                        var max = Math.round(values[1]);

                        $("#slider-range-value1").text(formatPrice(min));
                        $("#slider-range-value2").text(formatPrice(max));

                        $("#minPrice").val(min);
                        $("#maxPrice").val(max);
                    });
                }

                /* ===== DIỆN TÍCH ===== */
                var sizeSlider = document.getElementById("slider-range2");
                if (sizeSlider) {

                    if (sizeSlider.noUiSlider)
                        sizeSlider.noUiSlider.destroy();

                    noUiSlider.create(sizeSlider, {
                        start: [0, 500], // 0 – 500 m²
                        connect: true,
                        range: {
                            min: 0,
                            max: 500
                        },
                        step: 1
                    });

                    // HIỂN THỊ BAN ĐẦU
                    $("#slider-range-value01").text("0 m²");
                    $("#slider-range-value02").text("500 m²");

                    sizeSlider.noUiSlider.on('update', function (values) {
                        var min = Math.round(values[0]);
                        var max = Math.round(values[1]);

                        $("#slider-range-value01").text(min + " m²");
                        $("#slider-range-value02").text(max + " m²");

                        $("#minSize").val(min);
                        $("#maxSize").val(max);
                    });
                }
            }

            /* =========================
               SALE SLIDERS (BÁN)
            ========================== */

            function initSaleSliders() {

                var priceSlider = document.getElementById("slider-range-sale");
                if (priceSlider) {

                    if (priceSlider.noUiSlider)
                        priceSlider.noUiSlider.destroy();

                    noUiSlider.create(priceSlider, {
                        start: [1000000000, 20000000000],
                        connect: true,
                        range: {
                            min: 1000000000,
                            max: 20000000000
                        },
                        step: 100000000
                    });

                    $("#slider-range-value1-sale").text(formatPrice(1000000000));
                    $("#slider-range-value2-sale").text(formatPrice(20000000000));

                    priceSlider.noUiSlider.on('update', function (values) {
                        var min = Math.round(values[0]);
                        var max = Math.round(values[1]);

                        $("#slider-range-value1-sale").text(formatPrice(min));
                        $("#slider-range-value2-sale").text(formatPrice(max));

                        $("#minPriceSale").val(min);
                        $("#maxPriceSale").val(max);
                    });
                }

                var sizeSlider = document.getElementById("slider-range2-sale");
                if (sizeSlider) {

                    if (sizeSlider.noUiSlider)
                        sizeSlider.noUiSlider.destroy();

                    noUiSlider.create(sizeSlider, {
                        start: [0, 500],
                        connect: true,
                        range: {
                            min: 0,
                            max: 500
                        },
                        step: 1
                    });

                    $("#slider-range-value01-sale").text("0 m²");
                    $("#slider-range-value02-sale").text("500 m²");

                    sizeSlider.noUiSlider.on('update', function (values) {
                        var min = Math.round(values[0]);
                        var max = Math.round(values[1]);

                        $("#slider-range-value01-sale").text(min + " m²");
                        $("#slider-range-value02-sale").text(max + " m²");

                        $("#minSizeSale").val(min);
                        $("#maxSizeSale").val(max);
                    });
                }
            }

            /* =========================
               TAB SWITCH
            ========================== */

            $('a[data-bs-toggle="tab"][data-status-id]').on('shown.bs.tab', function (e) {
                var statusId = $(e.target).data('status-id');
                if (statusId === 1) initRentSliders();
                if (statusId === 2) initSaleSliders();
            });

            /* =========================
               INIT ON LOAD
            ========================== */

            initRentSliders();
        });
    </script>
}

