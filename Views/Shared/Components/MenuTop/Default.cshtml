@model IEnumerable<HomeLengo.Models.Menu>

<nav class="main-menu show navbar-expand-md">
    <div class="navbar-collapse collapse clearfix" id="navbarSupportedContent">
        <ul class="navigation clearfix">

            @foreach (var parent in Model.Where(m => m.ParentId == null).OrderBy(m => m.SortOrder))
            {
                // 🚫 Nếu là "Bảng điều khiển" mà CHƯA đăng nhập → bỏ qua
                if (parent.Title == "Bảng điều khiển"
                && Context.Session.GetString("UserId") == null)
                {
                    continue;
                }

                var childs = Model.Where(m => m.ParentId == parent.MenuId)
                .OrderBy(m => m.SortOrder)
                .ToList();

                <li class="@(childs.Any() ? "dropdown2" : "")">
                    <a href="@parent.Url">@parent.Title</a>

                    @if (childs.Any())
                    {
                        <ul>
                            @foreach (var child in childs)
                            {
                                // Xử lý đặc biệt cho "Hồ Sơ Của Tôi" - cần kiểm tra agentId
                                var url = child.Url;
                                if ((child.Title.Equals("Hồ Sơ Của Tôi", StringComparison.OrdinalIgnoreCase) || 
                                     child.Title.Equals("My Profile", StringComparison.OrdinalIgnoreCase) ||
                                     child.Title.Equals("Profile", StringComparison.OrdinalIgnoreCase)) &&
                                    parent.Title.Contains("Bảng Điều Khiển", StringComparison.OrdinalIgnoreCase))
                                {
                                    var agentIdStr = Context.Session.GetString("AgentId");
                                    int agentId = 0;
                                    if (int.TryParse(agentIdStr, out agentId) && agentId > 0)
                                    {
                                        url = $"/Agent/Profile/{agentId}";
                                    }
                                    else
                                    {
                                        url = "/Admin/User/Profile";
                                    }
                                }
                                <li><a href="@url">@child.Title</a></li>
                            }
                        </ul>
                    }
                </li>
            }
        </ul>
    </div>
</nav>
